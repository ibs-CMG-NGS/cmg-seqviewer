name: Build CMG-SeqViewer

on:
  push:
    tags:
      - 'v*'  # v1.0.0 Í∞ôÏùÄ ÌÉúÍ∑∏ Ìë∏Ïãú Ïãú Ïã§Ìñâ
  workflow_dispatch:  # ÏàòÎèô Ïã§Ìñâ Í∞ÄÎä•

permissions:
  contents: write  # Required for creating releases

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller pillow
      
      - name: Create icon
        run: python create_icon.py
      
      - name: Build executable
        run: |
          pyinstaller --clean --noconfirm rna-seq-viewer.spec
      
      - name: Create ZIP archive
        run: |
          Compress-Archive -Path "dist\CMG-SeqViewer" -DestinationPath "CMG-SeqViewer-Windows.zip"
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: CMG-SeqViewer-Windows
          path: CMG-SeqViewer-Windows.zip

  build-macos:
    runs-on: macos-latest  # Use latest macOS for faster build availability
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip3 install -r requirements.txt
          pip3 install pyinstaller pillow
      
      - name: Create icon (PNG)
        run: python3 create_icon.py
      
      - name: Convert icon to ICNS
        run: |
          mkdir cmg-seqviewer.iconset
          sips -z 16 16     cmg-seqviewer.png --out cmg-seqviewer.iconset/icon_16x16.png
          sips -z 32 32     cmg-seqviewer.png --out cmg-seqviewer.iconset/icon_16x16@2x.png
          sips -z 32 32     cmg-seqviewer.png --out cmg-seqviewer.iconset/icon_32x32.png
          sips -z 64 64     cmg-seqviewer.png --out cmg-seqviewer.iconset/icon_32x32@2x.png
          sips -z 128 128   cmg-seqviewer.png --out cmg-seqviewer.iconset/icon_128x128.png
          sips -z 256 256   cmg-seqviewer.png --out cmg-seqviewer.iconset/icon_128x128@2x.png
          sips -z 256 256   cmg-seqviewer.png --out cmg-seqviewer.iconset/icon_256x256.png
          sips -z 512 512   cmg-seqviewer.png --out cmg-seqviewer.iconset/icon_256x256@2x.png
          sips -z 512 512   cmg-seqviewer.png --out cmg-seqviewer.iconset/icon_512x512.png
          sips -z 1024 1024 cmg-seqviewer.png --out cmg-seqviewer.iconset/icon_512x512@2x.png
          iconutil -c icns cmg-seqviewer.iconset
          rm -rf cmg-seqviewer.iconset
      
      - name: Build executable
        run: |
          pyinstaller --clean --noconfirm cmg-seqviewer-macos.spec
      
      - name: Fix macOS app permissions and attributes
        run: |
          # Set executable permissions
          chmod +x dist/CMG-SeqViewer.app/Contents/MacOS/CMG-SeqViewer
          
          # Remove quarantine attribute
          xattr -cr dist/CMG-SeqViewer.app
          
          # Verify executable exists and is correct type
          echo "üîç Checking executable file:"
          file dist/CMG-SeqViewer.app/Contents/MacOS/CMG-SeqViewer
          ls -lh dist/CMG-SeqViewer.app/Contents/MacOS/CMG-SeqViewer
          
          # Check for dynamic library dependencies
          echo ""
          echo "üîç Checking library dependencies:"
          otool -L dist/CMG-SeqViewer.app/Contents/MacOS/CMG-SeqViewer | head -20
          
          # Verify it's not a broken symlink
          echo ""
          echo "üîç Verifying file integrity:"
          if [ -f "dist/CMG-SeqViewer.app/Contents/MacOS/CMG-SeqViewer" ]; then
            echo "‚úÖ Executable file exists"
          else
            echo "‚ùå Executable file NOT found!"
            exit 1
          fi
          
          # Codesign verification
          echo ""
          echo "üîç Code signature check:"
          codesign --verify --verbose dist/CMG-SeqViewer.app || echo "‚ö†Ô∏è  App is not signed (expected for open source)"
      
      - name: Create DMG with Applications symlink
        run: |
          # Create temporary directory for DMG contents
          mkdir -p dmg-temp
          
          # Copy app to temp directory
          cp -R dist/CMG-SeqViewer.app dmg-temp/
          
          # Create symlink to Applications folder
          ln -s /Applications dmg-temp/Applications
          
          # Create DMG from temp directory
          hdiutil create -volname "CMG-SeqViewer" \
                         -srcfolder dmg-temp \
                         -ov -format UDZO \
                         CMG-SeqViewer-macOS.dmg
          
          # Clean up temp directory
          rm -rf dmg-temp
          
          # Remove quarantine from DMG
          xattr -cr CMG-SeqViewer-macOS.dmg
          
          # Verify DMG was created
          ls -lh CMG-SeqViewer-macOS.dmg
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: CMG-SeqViewer-macOS
          path: CMG-SeqViewer-macOS.dmg

  create-release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: CMG-SeqViewer-Windows
      
      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: CMG-SeqViewer-macOS
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            CMG-SeqViewer-Windows.zip
            CMG-SeqViewer-macOS.dmg
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
